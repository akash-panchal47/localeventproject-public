{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard | CityPulse{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row min-vh-100">

    <!-- Sidebar -->
    <nav class="col-12 col-md-3 col-lg-2 sidebar bg-white p-3 d-flex flex-column border-end shadow-sm">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'index' %}">
    <img src="{% static 'app/events/images/logo.jpg.png' %}" 
         alt="CityPulse Logo" 
         class="d-inline-block align-top" 
         style="height:40px; width:auto;">
    <span class="ms-2 fw-bold text-dark"> CityPulse </span>
  </a>
      <ul class="nav flex-column">

        <!-- Profile Update Form -->
        <h5 class="fw-bold text-orange mb-3 mt-4">Update Profile</h5>
        <div class="bg-light p-3 rounded shadow-sm">
          <form method="POST">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-orange w-100 mt-2">Update</button>
          </form>
        </div>

        <li class="nav-item mt-auto">
          <a class="nav-link text-danger fw-bold mt-4" href="{% url 'logout' %}">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="col-12 col-md-9 col-lg-10 p-4">

      <!-- Welcome -->
      <h2 class="fw-bold text-orange text-center mb-5 animate__animated animate__fadeInDown">
        Welcome, {{ request.user.username }}
      </h2>

      <!-- My Joined Events -->
      <h3 class="fw-bold text-orange mb-4 text-center">My Joined Events</h3>
      <div class="row g-4 mb-5">
        {% for reg in registrations %}
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card shadow-lg border-0 rounded-3 overflow-hidden h-100 position-relative event-card">
            
            <!-- Event Image -->
            <img src="{{ reg.event.image.url|default:'https://via.placeholder.com/400x200' }}" 
                 class="card-img-top" alt="Event Image" 
                 style="height:220px; object-fit:cover;">

            <div class="card-body d-flex flex-column">
              <h5 class="fw-bold">{{ reg.event.title }}</h5>
              <p class="small text-muted">{{ reg.event.description|truncatewords:20 }}</p>
              <p><strong>Date:</strong> {{ reg.event.date }}</p>
              <p><strong>Status:</strong>
                {% if reg.status == 'pending' %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif reg.status == 'accepted' %}
                  <span class="badge bg-success">Accepted</span>
                {% else %}
                  <span class="badge bg-danger">Rejected</span>
                {% endif %}
              </p>

              <!-- View Payment Receipt Button (only if accepted) -->
              {% if reg.status == 'accepted' %}
                <a href="{% url 'payment_receipt' reg.id %}" 
                   class="btn btn-orange mt-2 align-self-start">
                   <i class="bi bi-receipt"></i> View Payment Receipt
                </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted text-center">No joined events yet.</p>
        {% endfor %}
      </div>

      <!-- All Registered Users with Events -->
      <h3 class="fw-bold text-orange mb-4 text-center">All Event Registrations</h3>
      <div class="table-responsive bg-white p-3 rounded shadow-lg mb-5">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>User</th>
              <th>Email</th>
              <th>Event</th>
              <th>Date Joined</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for reg in all_registrations %}
            <tr class="animate__animated animate__fadeInUp">
              <td>{{ forloop.counter }}</td>
              <td>{{ reg.user.username }}</td>
              <td>{{ reg.user.email }}</td>
              <td>{{ reg.event.title }}</td>
              <td>{{ reg.user.date_joined|date:"M d, Y" }}</td>
              <td>
                {% if reg.status == 'pending' %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif reg.status == 'accepted' %}
                  <span class="badge bg-success">Accepted</span>
                {% else %}
                  <span class="badge bg-danger">Rejected</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">No registrations found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- My Profile Info -->
      <h3 class="fw-bold text-orange mb-4 text-center">My Profile</h3>
      <div class="table-responsive bg-white p-3 rounded shadow-lg">
        <table class="table table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Date Joined</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ request.user.username }}</td>
              <td>{{ request.user.email }}</td>
              <td>{{ request.user.date_joined|date:"M d, Y" }}</td>
            </tr>
          </tbody>
        </table>
      </div>

    </main>
  </div>
</div>

<!-- Extra CSS -->
<style>
  .event-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .event-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
</style>

<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
